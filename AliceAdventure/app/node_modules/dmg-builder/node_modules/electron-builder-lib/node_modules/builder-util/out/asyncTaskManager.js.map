{"version":3,"file":"asyncTaskManager.js","sourceRoot":"","sources":["../src/asyncTaskManager.ts"],"names":[],"mappings":"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","sourcesContent":["import BluebirdPromise from \"bluebird-lst\"\nimport { CancellationToken } from \"builder-util-runtime\"\nimport { log } from \"./log\"\nimport { NestedError } from \"./promise\"\n\nexport class AsyncTaskManager {\n  readonly tasks: Array<Promise<any>> = []\n  private readonly errors: Array<Error> = []\n\n  constructor(private readonly cancellationToken: CancellationToken) {\n  }\n\n  add(task: () => Promise<any>) {\n    if (this.cancellationToken == null || !this.cancellationToken.cancelled) {\n      this.addTask(task())\n    }\n  }\n\n  addTask(promise: Promise<any>) {\n    if (this.cancellationToken.cancelled) {\n      log.debug({reason: \"cancelled\", stack: new Error().stack}, \"async task not added\")\n      if (\"cancel\" in promise) {\n        (promise as any).cancel()\n      }\n      return\n    }\n\n    this.tasks.push(promise\n      .catch(it => {\n        log.debug({error: it.message || it.toString()}, \"async task error\")\n        this.errors.push(it)\n        return Promise.resolve(null)\n      }))\n  }\n\n  cancelTasks() {\n    for (const task of this.tasks) {\n      if (\"cancel\" in task) {\n        (task as any).cancel()\n      }\n    }\n    this.tasks.length = 0\n  }\n\n  async awaitTasks(): Promise<Array<any>> {\n    if (this.cancellationToken.cancelled) {\n      this.cancelTasks()\n      return []\n    }\n\n    const checkErrors = () => {\n      if (this.errors.length > 0) {\n        this.cancelTasks()\n        throwError(this.errors)\n        return\n      }\n    }\n\n    checkErrors()\n\n    let result: Array<any> | null = null\n    const tasks = this.tasks\n    let list = tasks.slice()\n    tasks.length = 0\n    while (list.length > 0) {\n      const subResult = await BluebirdPromise.all(list)\n      result = result == null ? subResult : result.concat(subResult)\n      checkErrors()\n      if (tasks.length === 0) {\n        break\n      }\n      else {\n        if (this.cancellationToken.cancelled) {\n          this.cancelTasks()\n          return []\n        }\n\n        list = tasks.slice()\n        tasks.length = 0\n      }\n    }\n    return result || []\n  }\n}\n\nfunction throwError(errors: Array<Error>) {\n  if (errors.length === 1) {\n    throw errors[0]\n  }\n  else if (errors.length > 1) {\n    throw new NestedError(errors, \"Cannot cleanup: \")\n  }\n}"]}
