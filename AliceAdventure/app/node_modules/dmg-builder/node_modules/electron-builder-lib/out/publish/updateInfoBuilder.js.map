{"version":3,"file":"updateInfoBuilder.js","sourceRoot":"","sources":["../../src/publish/updateInfoBuilder.ts"],"names":[],"mappings":"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","sourcesContent":["import BluebirdPromise from \"bluebird-lst\"\nimport { Arch, hashFile, safeStringifyJson, serializeToYaml, log } from \"builder-util\"\nimport { GenericServerOptions, GithubOptions, PublishConfiguration, UpdateInfo, WindowsUpdateInfo } from \"builder-util-runtime\"\nimport { outputFile, outputJson, readFile } from \"fs-extra-p\"\nimport { Lazy } from \"lazy-val\"\nimport * as path from \"path\"\nimport * as semver from \"semver\"\nimport { ReleaseInfo } from \"../configuration\"\nimport { Platform } from \"../core\"\nimport { Packager } from \"../packager\"\nimport { ArtifactCreated } from \"../packagerApi\"\nimport { PlatformPackager } from \"../platformPackager\"\nimport { computeDownloadUrl, getPublishConfigsForUpdateInfo } from \"./PublishManager\"\n\nasync function getReleaseInfo(packager: PlatformPackager<any>) {\n  const releaseInfo: ReleaseInfo = {...(packager.platformSpecificBuildOptions.releaseInfo || packager.config.releaseInfo)}\n  if (releaseInfo.releaseNotes == null) {\n    const releaseNotesFile = await packager.getResource(releaseInfo.releaseNotesFile, `release-notes-${packager.platform.buildConfigurationKey}.md`, `release-notes-${packager.platform.name}.md`, `release-notes-${packager.platform.nodeName}.md`, \"release-notes.md\")\n    const releaseNotes = releaseNotesFile == null ? null : await readFile(releaseNotesFile, \"utf-8\")\n    // to avoid undefined in the file, check for null\n    if (releaseNotes != null) {\n      releaseInfo.releaseNotes = releaseNotes\n    }\n  }\n  delete releaseInfo.releaseNotesFile\n  return releaseInfo\n}\n\nfunction isGenerateUpdatesFilesForAllChannels(packager: PlatformPackager<any>) {\n  const value = packager.platformSpecificBuildOptions.generateUpdatesFilesForAllChannels\n  return value == null ? packager.config.generateUpdatesFilesForAllChannels : value\n}\n\n/**\n if this is an \"alpha\" version, we need to generate only the \"alpha\" .yml file\n if this is a \"beta\" version, we need to generate both the \"alpha\" and \"beta\" .yml file\n if this is a \"stable\" version, we need to generate all the \"alpha\", \"beta\" and \"stable\" .yml file\n */\nfunction computeChannelNames(packager: PlatformPackager<any>, publishConfig: PublishConfiguration): Array<string> {\n  const currentChannel: string = (publishConfig as GenericServerOptions).channel || \"latest\"\n  // for GitHub should be pre-release way be used\n  if (currentChannel === \"alpha\" || publishConfig.provider === \"github\" || !isGenerateUpdatesFilesForAllChannels(packager)) {\n    return [currentChannel]\n  }\n\n  switch (currentChannel) {\n    case \"beta\":\n      return [currentChannel, \"alpha\"]\n\n    case \"latest\":\n      return [currentChannel, \"alpha\", \"beta\"]\n\n    default:\n      return [currentChannel]\n  }\n}\n\nfunction getUpdateInfoFileName(channel: string, packager: PlatformPackager<any>, arch: Arch | null): string {\n  const osSuffix = packager.platform === Platform.WINDOWS ? \"\" : `-${packager.platform.buildConfigurationKey}`\n  const archSuffix = (arch != null && arch !== Arch.x64 && packager.platform === Platform.LINUX) ? `-${Arch[arch]}` : \"\"\n  return `${channel}${osSuffix}${archSuffix}.yml`\n}\n\nexport interface UpdateInfoFileTask {\n  readonly file: string\n  readonly info: UpdateInfo\n  readonly publishConfiguration: PublishConfiguration\n\n  readonly packager: PlatformPackager<any>\n}\n\n/** @internal */\nexport async function createUpdateInfoTasks(event: ArtifactCreated, _publishConfigs: Array<PublishConfiguration>): Promise<Array<UpdateInfoFileTask>> {\n  const packager = event.packager\n  const publishConfigs = await getPublishConfigsForUpdateInfo(packager, _publishConfigs, event.arch)\n  if (publishConfigs == null || publishConfigs.length === 0) {\n    return []\n  }\n\n  const outDir = event.target!.outDir\n  const version = packager.appInfo.version\n  const sha2 = new Lazy<string>(() => hashFile(event.file!, \"sha256\", \"hex\"))\n  const isMac = packager.platform === Platform.MAC\n  const createdFiles = new Set<string>()\n  const sharedInfo = await createUpdateInfo(version, event, await getReleaseInfo(packager))\n  const tasks: Array<UpdateInfoFileTask> = []\n  const electronUpdaterCompatibility = (packager.platformSpecificBuildOptions as any).electronUpdaterCompatibility\n  for (let publishConfiguration of publishConfigs) {\n    if (publishConfiguration.provider === \"github\" && \"releaseType\" in publishConfiguration) {\n      publishConfiguration = {...publishConfiguration!!}\n      delete (publishConfiguration as GithubOptions).releaseType\n    }\n\n    const isBintray = publishConfiguration.provider === \"bintray\"\n    let dir = outDir\n    // Bintray uses different variant of channel file info, better to generate it to a separate dir by always\n    if (isBintray || (publishConfigs.length > 1 && publishConfiguration !== publishConfigs[0])) {\n      dir = path.join(outDir, publishConfiguration.provider)\n    }\n\n    // spaces is a new publish provider, no need to keep backward compatibility\n    let isElectronUpdater1xCompatibility = publishConfiguration.provider !== \"spaces\" && (electronUpdaterCompatibility == null || semver.satisfies(\"1.0.0\", electronUpdaterCompatibility))\n\n    let info = sharedInfo\n    // noinspection JSDeprecatedSymbols\n    if (isElectronUpdater1xCompatibility && packager.platform === Platform.WINDOWS) {\n      info = {\n        ...info,\n      };\n      (info as WindowsUpdateInfo).sha2 = await sha2.value\n    }\n\n    if (event.safeArtifactName != null && publishConfiguration.provider === \"github\") {\n      const newFiles = info.files.slice()\n      newFiles[0].url = event.safeArtifactName\n      info = {\n        ...info,\n        files: newFiles,\n        path: event.safeArtifactName,\n      }\n    }\n\n    for (const channel of computeChannelNames(packager, publishConfiguration)) {\n      if (isMac && isElectronUpdater1xCompatibility && event.file.endsWith(\".zip\")) {\n        // write only for first channel (generateUpdatesFilesForAllChannels is a new functionality, no need to generate old mac update info file)\n        isElectronUpdater1xCompatibility = false\n        await writeOldMacInfo(publishConfiguration, outDir, dir, channel, createdFiles, version, packager)\n      }\n\n      const updateInfoFile = path.join(dir, (isBintray ? `${version}_` : \"\") + getUpdateInfoFileName(channel, packager, event.arch))\n      if (createdFiles.has(updateInfoFile)) {\n        continue\n      }\n\n      createdFiles.add(updateInfoFile)\n\n      // artifact should be uploaded only to designated publish provider\n      tasks.push({\n        file: updateInfoFile,\n        info,\n        publishConfiguration,\n        packager,\n      })\n    }\n  }\n  return tasks\n}\n\nasync function createUpdateInfo(version: string, event: ArtifactCreated, releaseInfo: ReleaseInfo): Promise<UpdateInfo> {\n  const customUpdateInfo = event.updateInfo\n  const url = path.basename(event.file!)\n  const sha512 = (customUpdateInfo == null ? null : customUpdateInfo.sha512) || await hashFile(event.file!)\n  const files = [{url, sha512}]\n  const result: UpdateInfo = {\n    version,\n    files,\n    path: url /* backward compatibility, electron-updater 1.x - electron-updater 2.15.0 */,\n    sha512 /* backward compatibility, electron-updater 1.x - electron-updater 2.15.0 */,\n    ...releaseInfo as UpdateInfo,\n  }\n\n  if (customUpdateInfo != null) {\n    // file info or nsis web installer packages info\n    Object.assign(\"sha512\" in customUpdateInfo ? files[0] : result, customUpdateInfo)\n  }\n  return result\n}\n\nexport async function writeUpdateInfoFiles(updateInfoFileTasks: Array<UpdateInfoFileTask>, packager: Packager) {\n  // zip must be first and zip info must be used for old path/sha512 properties in the update info\n  updateInfoFileTasks.sort((a, b) => (a.info.files[0].url.endsWith(\".zip\") ? 0 : 100) - (b.info.files[0].url.endsWith(\".zip\") ? 0 : 100))\n\n  const updateChannelFileToInfo = new Map<string, UpdateInfoFileTask>()\n  for (const task of updateInfoFileTasks) {\n    const key = `${task.file}@${safeStringifyJson(task.publishConfiguration)}`\n    const existingTask = updateChannelFileToInfo.get(key)\n    if (existingTask == null) {\n      updateChannelFileToInfo.set(key, task)\n      continue\n    }\n\n    existingTask.info.files.push(...task.info.files)\n  }\n\n  const releaseDate = new Date().toISOString()\n  await BluebirdPromise.map(updateChannelFileToInfo.values(), async task => {\n    const publishConfig = task.publishConfiguration\n    if (publishConfig.publishAutoUpdate === false) {\n      log.debug({\n        provider: publishConfig.provider,\n        reason: \"publishAutoUpdate is set to false\"\n      }, \"auto update metadata file not published\")\n      return\n    }\n\n    task.info.releaseDate = releaseDate\n    const fileContent = Buffer.from(serializeToYaml(task.info))\n    await outputFile(task.file, fileContent)\n    packager.dispatchArtifactCreated({\n      file: task.file,\n      fileContent,\n      arch: null,\n      packager: task.packager,\n      target: null,\n      publishConfig,\n    })\n  }, {concurrency: 4})\n}\n\n// backward compatibility - write json file\nasync function writeOldMacInfo(publishConfig: PublishConfiguration, outDir: string, dir: string, channel: string, createdFiles: Set<string>, version: string, packager: PlatformPackager<any>) {\n  const isGitHub = publishConfig.provider === \"github\"\n  const updateInfoFile = (isGitHub && outDir === dir) ? path.join(dir, \"github\", `${channel}-mac.json`) : path.join(dir, `${channel}-mac.json`)\n  if (!createdFiles.has(updateInfoFile)) {\n    createdFiles.add(updateInfoFile)\n    await outputJson(updateInfoFile, {\n      version,\n      releaseDate: new Date().toISOString(),\n      url: computeDownloadUrl(publishConfig, packager.generateName2(\"zip\", \"mac\", isGitHub), packager),\n    }, {spaces: 2})\n\n    packager.info.dispatchArtifactCreated({\n      file: updateInfoFile,\n      arch: null,\n      packager,\n      target: null,\n      publishConfig,\n    })\n  }\n}\n"]}
