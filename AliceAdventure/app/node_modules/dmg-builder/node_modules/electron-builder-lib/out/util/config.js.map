{"version":3,"file":"config.js","sourceRoot":"","sources":["../../src/util/config.ts"],"names":[],"mappings":"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","sourcesContent":["import { asArray, DebugLogger, InvalidConfigurationError, log, deepAssign } from \"builder-util\"\nimport { statOrNull } from \"builder-util/out/fs\"\nimport { readJson } from \"fs-extra-p\"\nimport { Lazy } from \"lazy-val\"\nimport * as path from \"path\"\nimport { getConfig as _getConfig, loadParentConfig, orNullIfFileNotExist, ReadConfigRequest, validateConfig as _validateConfig } from \"read-config-file\"\nimport { Configuration } from \"../configuration\"\nimport { reactCra } from \"../presets/rectCra\"\n\n// https://github.com/electron-userland/electron-builder/issues/1847\nfunction mergePublish(config: Configuration, configFromOptions: Configuration) {\n  // if config from disk doesn't have publish (or object), no need to handle, it will be simply merged by deepAssign\n  const publish = Array.isArray(config.publish) ? configFromOptions.publish : null\n  if (publish != null) {\n    delete (configFromOptions as any).publish\n  }\n\n  deepAssign(config, configFromOptions)\n\n  if (publish == null) {\n    return\n  }\n\n  const listOnDisk = config.publish as Array<any>\n  if (listOnDisk.length === 0) {\n    config.publish = publish\n  }\n  else {\n    // apply to first\n    Object.assign(listOnDisk[0], publish)\n  }\n}\n\nexport async function getConfig(projectDir: string, configPath: string | null, configFromOptions: Configuration | null | undefined, packageMetadata: Lazy<{ [key: string]: any } | null> = new Lazy(() => orNullIfFileNotExist(readJson(path.join(projectDir, \"package.json\"))))): Promise<Configuration> {\n  const configRequest: ReadConfigRequest = {packageKey: \"build\", configFilename: \"electron-builder\", projectDir, packageMetadata}\n  const configAndEffectiveFile = await _getConfig<Configuration>(configRequest, configPath)\n  const config = configAndEffectiveFile == null ? {} : configAndEffectiveFile.result\n  if (configFromOptions != null) {\n    mergePublish(config, configFromOptions)\n  }\n\n  if (configAndEffectiveFile != null) {\n    log.info({file: configAndEffectiveFile.configFile == null ? 'package.json (\"build\" field)' : configAndEffectiveFile.configFile}, \"loaded configuration\")\n  }\n\n  let extendsSpec = config.extends\n  if (extendsSpec == null && extendsSpec !== null) {\n    const metadata = await packageMetadata.value || {}\n    const devDependencies = metadata.devDependencies\n    const dependencies = metadata.dependencies\n    if ((dependencies != null && \"react-scripts\" in dependencies) || (devDependencies != null && \"react-scripts\" in devDependencies)) {\n      extendsSpec = \"react-cra\"\n      config.extends = extendsSpec\n    }\n    else if (devDependencies != null && \"electron-webpack\" in devDependencies) {\n      extendsSpec = \"electron-webpack/electron-builder.yml\"\n      config.extends = extendsSpec\n    }\n  }\n\n  if (extendsSpec == null) {\n    return deepAssign(getDefaultConfig(), config)\n  }\n\n  let parentConfig: Configuration | null\n  if (extendsSpec === \"react-cra\") {\n    parentConfig = await reactCra(projectDir)\n    log.info({preset: extendsSpec}, \"loaded parent configuration\")\n  }\n  else {\n    const parentConfigAndEffectiveFile = await loadParentConfig<Configuration>(configRequest, extendsSpec)\n    log.info({file: parentConfigAndEffectiveFile.configFile}, \"loaded parent configuration\")\n    parentConfig = parentConfigAndEffectiveFile.result\n  }\n\n  // electron-webpack and electrify client config - want to exclude some files\n  // we add client files configuration to main parent file matcher\n  if (parentConfig.files != null && config.files != null && (Array.isArray(config.files) || typeof config.files === \"string\") && Array.isArray(parentConfig.files) && parentConfig.files.length > 0) {\n    const mainFileSet = parentConfig.files[0]\n    if (typeof mainFileSet === \"object\" && (mainFileSet.from == null || mainFileSet.from === \".\")) {\n      mainFileSet.filter = asArray(mainFileSet.filter)\n      mainFileSet.filter.push(...asArray(config.files as any))\n      delete (config as any).files\n    }\n  }\n\n  return deepAssign(getDefaultConfig(), parentConfig, config)\n}\n\nfunction getDefaultConfig(): Configuration {\n  return {\n    directories: {\n      output: \"dist\",\n      buildResources: \"build\",\n    },\n  }\n}\n\nconst schemeDataPromise = new Lazy(() => readJson(path.join(__dirname, \"..\", \"..\", \"scheme.json\")))\n\nexport async function validateConfig(config: Configuration, debugLogger: DebugLogger) {\n  const extraMetadata = config.extraMetadata\n  if (extraMetadata != null) {\n    if (extraMetadata.build != null) {\n      throw new InvalidConfigurationError(`--em.build is deprecated, please specify as -c\"`)\n    }\n    if (extraMetadata.directories != null) {\n      throw new InvalidConfigurationError(`--em.directories is deprecated, please specify as -c.directories\"`)\n    }\n  }\n\n  // noinspection JSDeprecatedSymbols\n  if (config.npmSkipBuildFromSource === false) {\n    config.buildDependenciesFromSource = false\n  }\n\n  await _validateConfig(config, schemeDataPromise, (message, errors) => {\n    if (debugLogger.enabled) {\n      debugLogger.add(\"invalidConfig\", JSON.stringify(errors, null, 2))\n    }\n\n    return `${message}\n\nHow to fix:\n1. Open https://electron.build/configuration/configuration\n2. Search the option name on the page.\n  * Not found? The option was deprecated or not exists (check spelling).\n  * Found? Check that the option in the appropriate place. e.g. \"title\" only in the \"dmg\", not in the root.\n`\n  })\n}\n\nconst DEFAULT_APP_DIR_NAMES = [\"app\", \"www\"]\n\nexport async function computeDefaultAppDirectory(projectDir: string, userAppDir: string | null | undefined): Promise<string> {\n  if (userAppDir != null) {\n    const absolutePath = path.resolve(projectDir, userAppDir)\n    const stat = await statOrNull(absolutePath)\n    if (stat == null) {\n      throw new InvalidConfigurationError(`Application directory ${userAppDir} doesn't exists`)\n    }\n    else if (!stat.isDirectory()) {\n      throw new InvalidConfigurationError(`Application directory ${userAppDir} is not a directory`)\n    }\n    else if (projectDir === absolutePath) {\n      log.warn({appDirectory: userAppDir}, `Specified application directory equals to project dir — superfluous or wrong configuration`)\n    }\n    return absolutePath\n  }\n\n  for (const dir of DEFAULT_APP_DIR_NAMES) {\n    const absolutePath = path.join(projectDir, dir)\n    const packageJson = path.join(absolutePath, \"package.json\")\n    const stat = await statOrNull(packageJson)\n    if (stat != null && stat.isFile()) {\n      return absolutePath\n    }\n  }\n  return projectDir\n}"]}
