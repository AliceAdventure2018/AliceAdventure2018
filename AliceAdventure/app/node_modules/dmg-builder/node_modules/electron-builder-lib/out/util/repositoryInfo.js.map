{"version":3,"file":"repositoryInfo.js","sourceRoot":"","sources":["../../src/util/repositoryInfo.ts"],"names":[],"mappings":"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","sourcesContent":["import { orNullIfFileNotExist } from \"builder-util/out/promise\"\nimport { readFile } from \"fs-extra-p\"\nimport { fromUrl, Info } from \"hosted-git-info\"\nimport * as path from \"path\"\nimport { SourceRepositoryInfo } from \"../core\"\nimport { Metadata, RepositoryInfo } from \"..\"\n\nexport function getRepositoryInfo(projectDir: string, metadata?: Metadata, devMetadata?: Metadata | null): Promise<SourceRepositoryInfo | null> {\n  return _getInfo(projectDir, (devMetadata == null ? null : devMetadata.repository) || (metadata == null ? null : metadata.repository))\n}\n\nasync function getGitUrlFromGitConfig(projectDir: string): Promise<string | null> {\n  const data = await orNullIfFileNotExist(readFile(path.join(projectDir, \".git\", \"config\"), \"utf8\"))\n  if (data == null) {\n    return null\n  }\n\n  const conf = data.split(/\\r?\\n/)\n  const i = conf.indexOf('[remote \"origin\"]')\n  if (i !== -1) {\n    let u = conf[i + 1]\n    if (!u.match(/^\\s*url =/)) {\n      u = conf[i + 2]\n    }\n\n    if (u.match(/^\\s*url =/)) {\n      return u.replace(/^\\s*url = /, \"\")\n    }\n  }\n  return null\n}\n\nasync function _getInfo(projectDir: string, repo?: RepositoryInfo | string | null): Promise<SourceRepositoryInfo | null> {\n  if (repo != null) {\n    return parseRepositoryUrl(typeof repo === \"string\" ? repo : repo.url)\n  }\n\n  const slug = process.env.TRAVIS_REPO_SLUG || process.env.APPVEYOR_REPO_NAME\n  if (slug != null) {\n    const splitted = slug.split(\"/\")\n    return {\n      user: splitted[0],\n      project: splitted[1],\n    }\n  }\n\n  const user = process.env.CIRCLE_PROJECT_USERNAME\n  const project = process.env.CIRCLE_PROJECT_REPONAME\n  if (user != null && project != null) {\n    return {\n      user,\n      project,\n    }\n  }\n\n  const url = await getGitUrlFromGitConfig(projectDir)\n  return url == null ? null : parseRepositoryUrl(url)\n}\n\nfunction parseRepositoryUrl(url: string): Info {\n  const info: any = fromUrl(url)\n  if (info != null) {\n    delete info.protocols\n    delete info.treepath\n    delete info.filetemplate\n    delete info.bugstemplate\n    delete info.gittemplate\n    delete info.tarballtemplate\n    delete info.sshtemplate\n    delete info.sshurltemplate\n    delete info.browsetemplate\n    delete info.docstemplate\n    delete info.httpstemplate\n    delete info.shortcuttemplate\n    delete info.pathtemplate\n    delete info.pathmatch\n    delete info.protocols_re\n    delete info.committish\n    delete info.default\n    delete info.opts\n  }\n  return info\n}"]}
