{"version":3,"file":"cacheManager.js","sourceRoot":"","sources":["../../src/util/cacheManager.ts"],"names":[],"mappings":"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","sourcesContent":["import BluebirdPromise from \"bluebird-lst\"\nimport { Arch, log } from \"builder-util\"\nimport { copyFile } from \"builder-util/out/fs\"\nimport { orNullIfFileNotExist } from \"builder-util/out/promise\"\nimport { Hash } from \"crypto\"\nimport { ensureDir, readFile, readJson, writeJson } from \"fs-extra-p\"\nimport * as path from \"path\"\n\nexport interface BuildCacheInfo {\n  executableDigest: string\n}\n\nexport class BuildCacheManager {\n  static VERSION: string = \"0\"\n\n  readonly cacheDir: string\n  readonly cacheInfoFile: string\n  readonly cacheFile: string\n\n  cacheInfo: BuildCacheInfo | null = null\n\n  private newDigest: string | null = null\n\n  constructor(outDir: string, private readonly executableFile: string, arch: Arch) {\n    this.cacheDir = path.join(outDir, \".cache\", Arch[arch])\n    this.cacheFile = path.join(this.cacheDir, \"app.exe\")\n    this.cacheInfoFile = path.join(this.cacheDir, \"info.json\")\n  }\n\n  async copyIfValid(digest: string): Promise<boolean> {\n    this.newDigest = digest\n\n    this.cacheInfo = await orNullIfFileNotExist(readJson(this.cacheInfoFile))\n    const oldDigest = this.cacheInfo == null ? null : this.cacheInfo.executableDigest\n    if (oldDigest !== digest) {\n      log.debug({oldDigest, newDigest: digest}, \"no valid cached executable found\")\n      return false\n    }\n\n    log.debug({cacheFile: this.cacheFile, file: this.executableFile}, `copying cached executable`)\n    try {\n      await copyFile(this.cacheFile, this.executableFile, false)\n      return true\n    }\n    catch (e) {\n      if (e.code === \"ENOENT\" || e.code === \"ENOTDIR\") {\n        log.debug({error: e.code}, \"copy cached executable failed\")\n      }\n      else {\n        log.warn({error: e.stack || e}, `cannot copy cached executable`)\n      }\n    }\n    return false\n  }\n\n  async save() {\n    if (this.newDigest == null) {\n      throw new Error(\"call copyIfValid before\")\n    }\n\n    if (this.cacheInfo == null) {\n      this.cacheInfo = {executableDigest: this.newDigest}\n    }\n    else {\n      this.cacheInfo.executableDigest = this.newDigest\n    }\n\n    try {\n      await ensureDir(this.cacheDir)\n      await BluebirdPromise.all([writeJson(this.cacheInfoFile, this.cacheInfo), copyFile(this.executableFile, this.cacheFile, false)])\n    }\n    catch (e) {\n      log.warn({error: e.stack || e}, `cannot save build cache`)\n    }\n  }\n}\n\nexport async function digest(hash: Hash, files: Array<string>) {\n  // do not use pipe - better do bulk file read (https://github.com/yarnpkg/yarn/commit/7a63e0d23c46a4564bc06645caf8a59690f04d01)\n  for (const content of await BluebirdPromise.map(files, it => readFile(it))) {\n    hash.update(content)\n  }\n\n  hash.update(BuildCacheManager.VERSION)\n  return hash.digest(\"base64\")\n}"]}
