{"version":3,"file":"archive.js","sourceRoot":"","sources":["../../src/targets/archive.ts"],"names":[],"mappings":"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","sourcesContent":["import { path7za } from \"7zip-bin\"\nimport { debug7z, debug7zArgs, exec } from \"builder-util\"\nimport { exists, unlinkIfExists } from \"builder-util/out/fs\"\nimport { move } from \"fs-extra-p\"\nimport * as path from \"path\"\nimport { TmpDir } from \"temp-file\"\nimport { CompressionLevel } from \"../core\"\nimport { getLinuxToolsPath } from \"./tools\"\n\n/** @internal */\nexport async function tar(compression: CompressionLevel | any | any, format: string, outFile: string, dirToArchive: string, isMacApp: boolean, tempDirManager: TmpDir): Promise<void> {\n  const tarFile = await tempDirManager.getTempFile({suffix: \".tar\"})\n  const tarArgs = debug7zArgs(\"a\")\n  tarArgs.push(tarFile)\n  tarArgs.push(path.basename(dirToArchive))\n\n  await Promise.all([\n    exec(path7za, tarArgs, {cwd: path.dirname(dirToArchive)}),\n    // remove file before - 7z doesn't overwrite file, but update\n    unlinkIfExists(outFile),\n  ])\n\n  if (!isMacApp) {\n    await exec(path7za, [\"rn\", tarFile, path.basename(dirToArchive), path.basename(outFile, `.${format}`)])\n  }\n\n  if (format === \"tar.lz\") {\n    // noinspection SpellCheckingInspection\n    let lzipPath = \"lzip\"\n    if (process.platform === \"darwin\") {\n      lzipPath = path.join(await getLinuxToolsPath(), \"bin\", lzipPath)\n    }\n    await exec(lzipPath, [compression === \"store\" ? \"-1\" : \"-9\", \"--keep\" /* keep (don't delete) input files */, tarFile])\n    // bloody lzip creates file in the same dir where input file with postfix `.lz`, option --output doesn't work\n    await move(`${tarFile}.lz`, outFile)\n    return\n  }\n\n  const args = compute7zCompressArgs(format === \"tar.xz\" ? \"xz\" : (format === \"tar.bz2\" ? \"bzip2\" : \"gzip\"), {\n    isRegularFile: true,\n    method: \"DEFAULT\",\n    compression,\n  })\n  args.push(outFile, tarFile)\n  await exec(path7za, args, {\n    cwd: path.dirname(dirToArchive),\n  }, debug7z.enabled)\n}\n\nexport interface ArchiveOptions {\n  compression?: CompressionLevel | null\n\n  /**\n   * @default false\n   */\n  withoutDir?: boolean\n\n  /**\n   * @default true\n   */\n  solid?: boolean\n\n  /**\n   * @default true\n   */\n  isArchiveHeaderCompressed?: boolean\n\n  listFile?: string\n\n  dictSize?: number\n  excluded?: Array<string> | null\n\n  // DEFAULT allows to disable custom logic and do not pass method switch at all\n  method?: \"Copy\" | \"LZMA\" | \"Deflate\" | \"DEFAULT\"\n\n  isRegularFile?: boolean\n}\n\nexport function compute7zCompressArgs(format: string, options: ArchiveOptions = {}) {\n  let storeOnly = options.compression === \"store\"\n  const args = debug7zArgs(\"a\")\n\n  let isLevelSet = false\n  if (process.env.ELECTRON_BUILDER_COMPRESSION_LEVEL != null) {\n    storeOnly = false\n    args.push(`-mx=${process.env.ELECTRON_BUILDER_COMPRESSION_LEVEL}`)\n    isLevelSet = true\n  }\n\n  if (format === \"zip\" && options.compression === \"maximum\") {\n    // http://superuser.com/a/742034\n    args.push(\"-mfb=258\", \"-mpass=15\")\n  }\n\n  if (!isLevelSet && !storeOnly) {\n    args.push(\"-mx=9\")\n  }\n\n  if (options.dictSize != null) {\n    args.push(`-md=${options.dictSize}m`)\n  }\n\n  // https://sevenzip.osdn.jp/chm/cmdline/switches/method.htm#7Z\n  // https://stackoverflow.com/questions/27136783/7zip-produces-different-output-from-identical-input\n  // tc and ta are off by default, but to be sure, we explicitly set it to off\n  // disable \"Stores NTFS timestamps for files: Modification time, Creation time, Last access time.\" to produce the same archive for the same data\n  if (!options.isRegularFile) {\n    args.push(\"-mtc=off\")\n  }\n\n  if (format === \"7z\" || format.endsWith(\".7z\")) {\n    if (options.solid === false) {\n      args.push(\"-ms=off\")\n    }\n\n    if (options.isArchiveHeaderCompressed === false) {\n      args.push(\"-mhc=off\")\n    }\n\n    // args valid only for 7z\n    // -mtm=off disable \"Stores last Modified timestamps for files.\"\n    args.push(\"-mtm=off\", \"-mta=off\")\n  }\n\n  if (options.method != null) {\n    if (options.method !== \"DEFAULT\") {\n      args.push(`-mm=${options.method}`)\n    }\n  }\n  else if (format === \"zip\" || storeOnly) {\n    args.push(`-mm=${storeOnly ? \"Copy\" : \"Deflate\"}`)\n  }\n\n  if (format === \"zip\") {\n    // -mcu switch:  7-Zip uses UTF-8, if there are non-ASCII symbols.\n    // because default mode: 7-Zip uses UTF-8, if the local code page doesn't contain required symbols.\n    // but archive should be the same regardless where produced\n    args.push(\"-mcu\")\n  }\n  return args\n}\n\n// 7z is very fast, so, use ultra compression\n/** @internal */\nexport async function archive(format: string, outFile: string, dirToArchive: string, options: ArchiveOptions = {}): Promise<string> {\n  const args = compute7zCompressArgs(format, options)\n  // remove file before - 7z doesn't overwrite file, but update\n  await unlinkIfExists(outFile)\n\n  args.push(outFile, options.listFile == null ? (options.withoutDir ? \".\" : path.basename(dirToArchive)) : `@${options.listFile}`)\n  if (options.excluded != null) {\n    for (const mask of options.excluded) {\n      args.push(`-xr!${mask}`)\n    }\n  }\n\n  try {\n    await exec(path7za, args, {\n      cwd: options.withoutDir ? dirToArchive : path.dirname(dirToArchive),\n    }, debug7z.enabled)\n  }\n  catch (e) {\n    if (e.code === \"ENOENT\" && !(await exists(dirToArchive))) {\n      throw new Error(`Cannot create archive: \"${dirToArchive}\" doesn't exist`)\n    }\n    else {\n      throw e\n    }\n  }\n\n  return outFile\n}"]}
