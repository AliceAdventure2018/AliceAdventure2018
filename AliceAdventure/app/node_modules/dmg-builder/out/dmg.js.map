{"version":3,"file":"dmg.js","sourceRoot":"","sources":["../src/dmg.ts"],"names":[],"mappings":"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","sourcesContent":["import { Arch, AsyncTaskManager, exec, InvalidConfigurationError, isCanSignDmg, isEmptyOrSpaces, log, spawn, deepAssign, executeAppBuilder } from \"builder-util\"\nimport { CancellationToken } from \"builder-util-runtime\"\nimport { copyDir, copyFile, exists, statOrNull } from \"builder-util/out/fs\"\nimport { addLicenseToDmg } from \"./dmgLicense\"\nimport { applyProperties, attachAndExecute, computeBackground, computeBackgroundColor, detach, transformBackgroundFileIfNeed } from \"./dmgUtil\"\nimport { stat } from \"fs-extra-p\"\nimport * as path from \"path\"\nimport sanitizeFileName from \"sanitize-filename\"\nimport { findIdentity, isSignAllowed } from \"electron-builder-lib/out/codeSign\"\nimport { Target, DmgOptions } from \"electron-builder-lib\"\nimport MacPackager from \"electron-builder-lib/out/macPackager\"\nimport { createBlockmap } from \"electron-builder-lib/out/targets/differentialUpdateInfoBuilder\"\n\nexport class DmgTarget extends Target {\n  readonly options: DmgOptions = this.packager.config.dmg || Object.create(null)\n\n  constructor(private readonly packager: MacPackager, readonly outDir: string) {\n    super(\"dmg\")\n  }\n\n  async build(appPath: string, arch: Arch) {\n    const packager = this.packager\n    // tslint:disable-next-line:no-invalid-template-strings\n    const artifactName = packager.expandArtifactNamePattern(packager.config.dmg, \"dmg\", null, \"${productName}-\" + (packager.platformSpecificBuildOptions.bundleShortVersion || \"${version}\") + \".${ext}\")\n    const artifactPath = path.join(this.outDir, artifactName)\n    this.logBuilding(\"DMG\", artifactPath, arch)\n\n    const specification = await this.computeDmgOptions()\n    const volumeName = sanitizeFileName(this.computeVolumeName(specification.title))\n\n    const tempDmg = await createStageDmg(await packager.getTempFile(\".dmg\"), appPath, volumeName)\n\n    // https://github.com/electron-userland/electron-builder/issues/2115\n    const backgroundFile = specification.background == null ? null : await transformBackgroundFileIfNeed(specification.background, packager.info.tempDirManager)\n    const finalSize = await computeAssetSize(packager.info.cancellationToken, tempDmg, specification, backgroundFile)\n    await exec(\"hdiutil\", [\"resize\", \"-size\", finalSize.toString(), tempDmg])\n\n    const volumePath = path.join(\"/Volumes\", volumeName)\n    if (await exists(volumePath)) {\n      log.debug({volumePath}, \"unmounting previous disk image\")\n      await detach(volumePath)\n    }\n\n    if (!await attachAndExecute(tempDmg, true, () => customizeDmg(volumePath, specification, packager, backgroundFile))) {\n      return\n    }\n\n    // dmg file must not exist otherwise hdiutil failed (https://github.com/electron-userland/electron-builder/issues/1308#issuecomment-282847594), so, -ov must be specified\n    const args = [\"convert\", tempDmg, \"-ov\", \"-format\", specification.format!, \"-o\", artifactPath]\n    if (specification.format === \"UDZO\") {\n      args.push(\"-imagekey\", `zlib-level=${process.env.ELECTRON_BUILDER_COMPRESSION_LEVEL || \"9\"}`)\n    }\n    await spawn(\"hdiutil\", addLogLevel(args))\n    if (this.options.internetEnabled) {\n      await exec(\"hdiutil\", addLogLevel([\"internet-enable\"]).concat(artifactPath))\n    }\n\n    const licenseData = await addLicenseToDmg(packager, artifactPath)\n    if (packager.packagerOptions.effectiveOptionComputed != null) {\n      await packager.packagerOptions.effectiveOptionComputed({licenseData})\n    }\n\n    await this.signDmg(artifactPath)\n\n    const safeArtifactName = packager.computeSafeArtifactName(artifactName, \"dmg\")\n    const updateInfo = await createBlockmap(artifactPath, this, packager, safeArtifactName)\n    packager.info.dispatchArtifactCreated({\n      file: artifactPath,\n      safeArtifactName,\n      target: this,\n      arch,\n      packager,\n      isWriteUpdateInfo: true,\n      updateInfo,\n    })\n  }\n\n  private async signDmg(artifactPath: string) {\n    if (!isSignAllowed(false)) {\n      return\n    }\n\n    if (!(await isCanSignDmg())) {\n      log.warn({solution: \"please update OS\"}, \"at least macOS 10.11.5 is required to sign DMG\")\n    }\n\n    const packager = this.packager\n    const qualifier = packager.platformSpecificBuildOptions.identity\n    // explicitly disabled if set to null\n    if (qualifier === null) {\n      // macPackager already somehow handle this situation, so, here just return\n      return\n    }\n\n    const keychainName = (await packager.codeSigningInfo.value).keychainName\n    const certificateType = \"Developer ID Application\"\n    let identity = await findIdentity(certificateType, qualifier, keychainName)\n    if (identity == null) {\n      identity = await findIdentity(\"Mac Developer\", qualifier, keychainName)\n      if (identity == null) {\n        return\n      }\n    }\n\n    const args = [\"--sign\", identity.hash]\n    if (keychainName != null) {\n      args.push(\"--keychain\", keychainName)\n    }\n    args.push(artifactPath)\n    await exec(\"codesign\", args)\n  }\n\n  computeVolumeName(custom?: string | null): string {\n    const appInfo = this.packager.appInfo\n    const shortVersion = this.packager.platformSpecificBuildOptions.bundleShortVersion || appInfo.version\n\n    if (custom == null) {\n      return `${appInfo.productFilename} ${shortVersion}`\n    }\n\n    return custom\n      .replace(/\\${shortVersion}/g, shortVersion)\n      .replace(/\\${version}/g, appInfo.version)\n      .replace(/\\${name}/g, appInfo.name)\n      .replace(/\\${productName}/g, appInfo.productName)\n  }\n\n  // public to test\n  async computeDmgOptions(): Promise<DmgOptions> {\n    // appdmg\n    const appdmgWindow = (this.options.window as any) || {}\n    const oldPosition = appdmgWindow.position\n    const oldSize = appdmgWindow.size\n    const oldIconSize = (this.options as any)[\"icon-size\"]\n    const oldBackgroundColor = (this.options as any)[\"background-color\"]\n    if (oldPosition != null) {\n      log.warn({solution: \"use dmg.window\"}, \"dmg.window.position is deprecated\")\n    }\n    if (oldSize != null) {\n      log.warn({solution: \"use dmg.window\"}, \"dmg.window.size is deprecated\")\n    }\n    if (oldIconSize != null) {\n      log.warn({solution: \"use dmg.iconSize\"}, \"dmg.icon-size is deprecated\")\n    }\n    if (oldBackgroundColor != null) {\n      log.warn({solution: \"use dmg.backgroundColor\"}, \"dmg.background-color is deprecated\")\n    }\n\n    const packager = this.packager\n    const specification = deepAssign<DmgOptions>({\n        window: {\n          x: 400,\n          y: 100,\n        },\n        iconSize: oldIconSize,\n        backgroundColor: oldBackgroundColor,\n        icon: \"icon\" in this.options ? undefined : await packager.getIconPath()\n      },\n      this.options,\n      oldPosition == null ? null : {\n        window: {\n          x: oldPosition.x,\n          y: oldPosition.y,\n        }\n      },\n      oldSize == null ? null : {\n        window: {\n          width: oldSize.width,\n          height: oldSize.height,\n        }\n      })\n\n    if (specification.icon != null && isEmptyOrSpaces(specification.icon)) {\n      throw new InvalidConfigurationError(\"dmg.icon cannot be specified as empty string\")\n    }\n\n    const background = specification.background\n    if (specification.backgroundColor != null) {\n      if (background != null) {\n        throw new InvalidConfigurationError(\"Both dmg.backgroundColor and dmg.background are specified — please set the only one\")\n      }\n      specification.backgroundColor = computeBackgroundColor(specification.backgroundColor)\n    }\n    else if (background == null) {\n      specification.background = await computeBackground(packager)\n    }\n    else {\n      specification.background = path.resolve(packager.info.projectDir, background)\n    }\n\n    if (specification.format == null) {\n      if (process.env.ELECTRON_BUILDER_COMPRESSION_LEVEL != null) {\n        (specification as any).format = \"UDZO\"\n      }\n      else if (packager.compression === \"store\") {\n        (specification as any).format = \"UDRO\"\n      }\n      else {\n        (specification as any).format = packager.compression === \"maximum\" ? \"UDBZ\" : \"UDZO\"\n      }\n    }\n\n    if (specification.contents == null) {\n      specification.contents = [\n        {\n          x: 130, y: 220\n        },\n        {\n          x: 410, y: 220, type: \"link\", path: \"/Applications\"\n        }\n      ]\n    }\n    return specification\n  }\n}\n\nasync function createStageDmg(tempDmg: string, appPath: string, volumeName: string) {\n  //noinspection SpellCheckingInspection\n  const imageArgs = addLogLevel([\"create\",\n    \"-srcfolder\", appPath,\n    \"-volname\", volumeName,\n    \"-anyowners\", \"-nospotlight\",\n    \"-format\", \"UDRW\",\n  ])\n  imageArgs.push(\"-fs\", \"HFS+\", \"-fsargs\", \"-c c=64,a=16,e=16\")\n  imageArgs.push(tempDmg)\n  await spawn(\"hdiutil\", imageArgs)\n  return tempDmg\n}\n\nfunction addLogLevel(args: Array<string>): Array<string> {\n  args.push(process.env.DEBUG_DMG === \"true\" ? \"-verbose\" : \"-quiet\")\n  return args\n}\n\nasync function computeAssetSize(cancellationToken: CancellationToken, dmgFile: string, specification: DmgOptions, backgroundFile: string | null | undefined) {\n  const asyncTaskManager = new AsyncTaskManager(cancellationToken)\n  asyncTaskManager.addTask(stat(dmgFile))\n\n  if (specification.icon != null) {\n    asyncTaskManager.addTask(statOrNull(specification.icon))\n  }\n\n  if (backgroundFile != null) {\n    asyncTaskManager.addTask(stat(backgroundFile))\n  }\n\n  let result = 32 * 1024\n  for (const stat of await asyncTaskManager.awaitTasks()) {\n    if (stat != null) {\n      result += stat.size\n    }\n  }\n  return result\n}\n\nasync function customizeDmg(volumePath: string, specification: DmgOptions, packager: MacPackager, backgroundFile: string | null | undefined) {\n  const window = specification.window!\n  const env: any = {\n    ...process.env,\n    volumePath,\n    appFileName: `${packager.appInfo.productFilename}.app`,\n    iconSize: specification.iconSize || 80,\n    iconTextSize: specification.iconTextSize || 12,\n\n    windowX: window.x,\n    windowY: window.y,\n\n    VERSIONER_PERL_PREFER_32_BIT: \"true\"\n  }\n\n  if (specification.backgroundColor != null || specification.background == null) {\n    env.backgroundColor = specification.backgroundColor || \"#ffffff\"\n    env.windowWidth = (window.width || 540).toString()\n    env.windowHeight = (window.height || 380).toString()\n  }\n  else {\n    delete env.backgroundColor\n\n    if (window.width == null) {\n      delete env.windowWidth\n    }\n    else {\n      env.windowWidth = window.width.toString()\n    }\n    if (window.height == null) {\n      delete env.windowHeight\n    }\n    else {\n      env.windowHeight = window.height.toString()\n    }\n  }\n\n  const args = [\"dmg\", \"--volume\", volumePath]\n  if (specification.icon != null) {\n    args.push(\"--icon\", (await packager.getResource(specification.icon))!!)\n  }\n  if (backgroundFile != null) {\n    env.backgroundFilename = path.basename(backgroundFile)\n    args.push(\"--background\", backgroundFile)\n  }\n  await executeAppBuilder(args)\n\n  const asyncTaskManager = new AsyncTaskManager(packager.info.cancellationToken)\n  await applyProperties(await computeDmgEntries(specification, volumePath, packager, asyncTaskManager), env, asyncTaskManager, packager)\n  return packager.packagerOptions.effectiveOptionComputed == null || !(await packager.packagerOptions.effectiveOptionComputed({volumePath, specification, packager}))\n}\n\nasync function computeDmgEntries(specification: DmgOptions, volumePath: string, packager: MacPackager, asyncTaskManager: AsyncTaskManager) {\n  let result = \"\"\n  for (const c of specification.contents!!) {\n    if (c.path != null && c.path.endsWith(\".app\") && c.type !== \"link\") {\n      log.warn({path: c.path, reason: \"actual path to app will be used instead\"}, `do not specify path for application`)\n    }\n\n    const entryPath = c.path || `${packager.appInfo.productFilename}.app`\n    const entryName = c.name || path.basename(entryPath)\n    result += `&makeEntries(\"${entryName}\", Iloc_xy => [ ${c.x}, ${c.y} ]),\\n`\n\n    if (c.type === \"link\") {\n      asyncTaskManager.addTask(exec(\"ln\", [\"-s\", `/${entryPath.startsWith(\"/\") ? entryPath.substring(1) : entryPath}`, `${volumePath}/${entryName}`]))\n    }\n    // use c.path instead of entryPath (to be sure that this logic is not applied to .app bundle) https://github.com/electron-userland/electron-builder/issues/2147\n    else if (!isEmptyOrSpaces(c.path) && (c.type === \"file\" || c.type === \"dir\")) {\n      const source = await packager.getResource(c.path)\n      if (source == null) {\n        log.warn({entryPath, reason: \"doesn't exist\"}, `skipped DMG item copying`)\n        continue\n      }\n\n      const destination = `${volumePath}/${entryName}`\n      asyncTaskManager.addTask(c.type === \"dir\" || (await stat(source)).isDirectory() ? copyDir(source, destination) : copyFile(source, destination))\n    }\n  }\n  return result\n}"]}
